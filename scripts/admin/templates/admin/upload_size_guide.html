{% extends "admin/base.html" %}

{% block title %}Upload Size Guide - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-upload"></i> Upload Size Guide</h2>
    <a href="{{ url_for('admin_size_guides') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Size Guides
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-wizard"></i> Size Guide Upload Wizard
                </h5>
            </div>
            <div class="card-body">
                <!-- Progress Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="progress mb-3" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" style="width: 33%;" id="progress-bar"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-primary" id="step-1-label"><strong>1. Brand Selection</strong></small>
                            <small class="text-muted" id="step-2-label">2. Size Guide Info</small>
                            <small class="text-muted" id="step-3-label">3. Size Data</small>
                        </div>
                    </div>
                </div>

                <form id="size-guide-form" method="POST">
                    <!-- Step 1: Brand Selection -->
                    <div id="step-1" class="wizard-step">
                        <h4>Step 1: Select or Create Brand</h4>
                        <hr>
                        
                        <div class="mb-3">
                            <label class="form-label">Choose Brand Option:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="brand_option" id="existing-brand" value="existing" checked>
                                <label class="form-check-label" for="existing-brand">
                                    Use Existing Brand
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="brand_option" id="new-brand" value="new">
                                <label class="form-check-label" for="new-brand">
                                    Create New Brand
                                </label>
                            </div>
                        </div>

                        <div id="existing-brand-section">
                            <div class="mb-3">
                                <label for="brand_id" class="form-label">Select Brand</label>
                                <select class="form-select" id="brand_id" name="brand_id">
                                    <option value="">Choose a brand...</option>
                                    {% for brand in brands %}
                                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div id="new-brand-section" style="display: none;">
                            <div class="mb-3">
                                <label for="new_brand_name" class="form-label">New Brand Name</label>
                                <input type="text" class="form-control" id="new_brand_name" name="new_brand_name" placeholder="Enter brand name">
                                <div class="form-text">This will create a new brand in the system.</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Size Guide Information -->
                    <div id="step-2" class="wizard-step" style="display: none;">
                        <h4>Step 2: Size Guide Information</h4>
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-select" id="gender" name="gender" required>
                                        <option value="">Select gender...</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Unisex">Unisex</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category_id" class="form-label">Category</label>
                                    <select class="form-select" id="category_id" name="category_id" required>
                                        <option value="">Select category...</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="source_url" class="form-label">Source URL</label>
                            <input type="url" class="form-control" id="source_url" name="source_url" placeholder="https://example.com/size-guide">
                            <div class="form-text">Link to the original size guide page</div>
                        </div>

                        <div class="mb-3">
                            <label for="screenshot_url" class="form-label">Screenshot URL</label>
                            <input type="url" class="form-control" id="screenshot_url" name="screenshot_url" placeholder="https://drive.google.com/...">
                            <div class="form-text">Link to screenshot of the size guide (Google Drive, etc.)</div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="previousStep(1)">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Size Data Entry -->
                    <div id="step-3" class="wizard-step" style="display: none;">
                        <h4>Step 3: Enter Size Data</h4>
                        <hr>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-success btn-sm" onclick="addSizeRow()">
                                <i class="fas fa-plus"></i> Add Size
                            </button>
                            <button type="button" class="btn btn-info btn-sm" onclick="addCommonSizes()">
                                <i class="fas fa-magic"></i> Add Common Sizes (XS-XXL)
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered" id="size-data-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Size Label</th>
                                        <th>Chest Min</th>
                                        <th>Chest Max</th>
                                        <th>Sleeve Min</th>
                                        <th>Sleeve Max</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="size-data-body">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Tips:</strong> Enter measurements in inches. Leave fields blank if not available in the size guide.
                        </div>

                        <input type="hidden" name="size_entries" id="size_entries">

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="previousStep(2)">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button type="submit" class="btn btn-success" onclick="submitForm()">
                                <i class="fas fa-upload"></i> Upload Size Guide
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-question-circle"></i> Help
                </h6>
            </div>
            <div class="card-body">
                <div id="help-step-1">
                    <h6>Brand Selection</h6>
                    <p class="small">Choose an existing brand from the dropdown, or create a new one if it doesn't exist in the system.</p>
                </div>
                <div id="help-step-2" style="display: none;">
                    <h6>Size Guide Info</h6>
                    <p class="small">Provide metadata about the size guide including gender, category, and source links.</p>
                </div>
                <div id="help-step-3" style="display: none;">
                    <h6>Size Data Entry</h6>
                    <p class="small">Enter the actual measurements for each size. Use the "Add Common Sizes" button for standard XS-XXL sizing.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let sizeRowCounter = 0;

// Handle brand option change
document.querySelectorAll('input[name="brand_option"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.value === 'existing') {
            document.getElementById('existing-brand-section').style.display = 'block';
            document.getElementById('new-brand-section').style.display = 'none';
        } else {
            document.getElementById('existing-brand-section').style.display = 'none';
            document.getElementById('new-brand-section').style.display = 'block';
        }
    });
});

function nextStep(step) {
    // Validate current step
    if (currentStep === 1 && !validateStep1()) return;
    if (currentStep === 2 && !validateStep2()) return;
    
    // Hide current step
    document.getElementById(`step-${currentStep}`).style.display = 'none';
    document.getElementById(`step-${currentStep}-label`).innerHTML = `${currentStep}. ${getStepName(currentStep)}`;
    document.getElementById(`step-${currentStep}-label`).className = 'text-success';
    
    // Show next step
    currentStep = step;
    document.getElementById(`step-${currentStep}`).style.display = 'block';
    document.getElementById(`step-${currentStep}-label`).innerHTML = `<strong>${currentStep}. ${getStepName(currentStep)}</strong>`;
    document.getElementById(`step-${currentStep}-label`).className = 'text-primary';
    
    // Update progress bar
    const progress = (currentStep / 3) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    
    // Update help
    document.querySelectorAll('[id^="help-step-"]').forEach(el => el.style.display = 'none');
    document.getElementById(`help-step-${currentStep}`).style.display = 'block';
}

function previousStep(step) {
    // Hide current step
    document.getElementById(`step-${currentStep}`).style.display = 'none';
    document.getElementById(`step-${currentStep}-label`).innerHTML = `${currentStep}. ${getStepName(currentStep)}`;
    document.getElementById(`step-${currentStep}-label`).className = 'text-muted';
    
    // Show previous step
    currentStep = step;
    document.getElementById(`step-${currentStep}`).style.display = 'block';
    document.getElementById(`step-${currentStep}-label`).innerHTML = `<strong>${currentStep}. ${getStepName(currentStep)}</strong>`;
    document.getElementById(`step-${currentStep}-label`).className = 'text-primary';
    
    // Update progress bar
    const progress = (currentStep / 3) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    
    // Update help
    document.querySelectorAll('[id^="help-step-"]').forEach(el => el.style.display = 'none');
    document.getElementById(`help-step-${currentStep}`).style.display = 'block';
}

function getStepName(step) {
    const names = {1: 'Brand Selection', 2: 'Size Guide Info', 3: 'Size Data'};
    return names[step];
}

function validateStep1() {
    const brandOption = document.querySelector('input[name="brand_option"]:checked').value;
    if (brandOption === 'existing') {
        const brandId = document.getElementById('brand_id').value;
        if (!brandId) {
            alert('Please select a brand.');
            return false;
        }
    } else {
        const brandName = document.getElementById('new_brand_name').value.trim();
        if (!brandName) {
            alert('Please enter a brand name.');
            return false;
        }
    }
    return true;
}

function validateStep2() {
    const gender = document.getElementById('gender').value;
    const category = document.getElementById('category_id').value;
    
    if (!gender) {
        alert('Please select a gender.');
        return false;
    }
    if (!category) {
        alert('Please select a category.');
        return false;
    }
    return true;
}

function addSizeRow(sizeLabel = '', chestMin = '', chestMax = '', sleeveMin = '', sleeveMax = '') {
    sizeRowCounter++;
    const tbody = document.getElementById('size-data-body');
    const row = document.createElement('tr');
    row.id = `size-row-${sizeRowCounter}`;
    
    row.innerHTML = `
        <td><input type="text" class="form-control" value="${sizeLabel}" placeholder="XS, S, M, L..." required></td>
        <td><input type="number" class="form-control" value="${chestMin}" placeholder="34.0" step="0.1"></td>
        <td><input type="number" class="form-control" value="${chestMax}" placeholder="36.0" step="0.1"></td>
        <td><input type="number" class="form-control" value="${sleeveMin}" placeholder="33.0" step="0.1"></td>
        <td><input type="number" class="form-control" value="${sleeveMax}" placeholder="33.5" step="0.1"></td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeSizeRow(${sizeRowCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
}

function removeSizeRow(rowId) {
    document.getElementById(`size-row-${rowId}`).remove();
}

function addCommonSizes() {
    const commonSizes = [
        {label: 'XS', chestMin: 34.0, chestMax: 36.0, sleeveMin: 33.0, sleeveMax: 33.5},
        {label: 'S', chestMin: 36.0, chestMax: 38.0, sleeveMin: 33.5, sleeveMax: 34.0},
        {label: 'M', chestMin: 38.0, chestMax: 40.0, sleeveMin: 34.0, sleeveMax: 34.5},
        {label: 'L', chestMin: 40.0, chestMax: 42.0, sleeveMin: 34.5, sleeveMax: 35.0},
        {label: 'XL', chestMin: 42.0, chestMax: 44.0, sleeveMin: 35.0, sleeveMax: 35.5},
        {label: 'XXL', chestMin: 44.0, chestMax: 46.0, sleeveMin: 35.5, sleeveMax: 36.0}
    ];
    
    commonSizes.forEach(size => {
        addSizeRow(size.label, size.chestMin, size.chestMax, size.sleeveMin, size.sleeveMax);
    });
}

function submitForm() {
    // Collect size data
    const sizeEntries = [];
    const rows = document.querySelectorAll('#size-data-body tr');
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const sizeLabel = inputs[0].value.trim();
        
        if (sizeLabel) {
            const entry = {
                size_label: sizeLabel,
                chest_min: inputs[1].value ? parseFloat(inputs[1].value) : null,
                chest_max: inputs[2].value ? parseFloat(inputs[2].value) : null,
                sleeve_min: inputs[3].value ? parseFloat(inputs[3].value) : null,
                sleeve_max: inputs[4].value ? parseFloat(inputs[4].value) : null
            };
            
            // Add range fields
            if (entry.chest_min && entry.chest_max) {
                entry.chest_range = `${entry.chest_min}-${entry.chest_max}`;
            }
            if (entry.sleeve_min && entry.sleeve_max) {
                entry.sleeve_range = `${entry.sleeve_min}-${entry.sleeve_max}`;
            }
            
            sizeEntries.push(entry);
        }
    });
    
    if (sizeEntries.length === 0) {
        alert('Please add at least one size entry.');
        return false;
    }
    
    // Set the size entries data
    document.getElementById('size_entries').value = JSON.stringify(sizeEntries);
    
    // Submit the form
    return true;
}
</script>
{% endblock %} 